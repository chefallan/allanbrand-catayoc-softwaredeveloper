# Backend

A high-performance Node.js/Express REST API for querying Ethereum network data with intelligent caching, dual persistence, and gas price tracking.

## Quick Start

```bash
# 1. Install dependencies
npm install

# 2. Configure environment
cp .env.example .env
# Edit .env and add your Alchemy API key and Infura ID

# 3. Terminal 1 - Start server
npm run dev

# 4. Terminal 2 - Test with addresses
npm run test
# Enter any Ethereum address (0x...) and it automatically saves to balances.json
```

## Directory Structure

```
backend/
â”œâ”€â”€ src/                          # TypeScript source files
â”‚   â”œâ”€â”€ index.ts                 # Server initialization & lifecycle management
â”‚   â”œâ”€â”€ routes.ts                # API endpoint definitions
â”‚   â”œâ”€â”€ ethereum.ts              # Ethers.js integration for blockchain queries
â”‚   â”œâ”€â”€ cache.ts                 # Dual-layer caching (Redis + in-memory)
â”‚   â”œâ”€â”€ database.ts              # Persistence layer (JSON + PostgreSQL)
â”‚   â”œâ”€â”€ config.ts                # Environment configuration management
â”‚   â”œâ”€â”€ middleware.ts            # Express middleware (CORS, logging, etc.)
â”‚   â””â”€â”€ test.ts                  # Interactive testing tool (TypeScript)
â”œâ”€â”€ data/                        # Data persistence directory
â”‚   â””â”€â”€ balances.json           # Cached Ethereum account balances
â”œâ”€â”€ dist/                        # Compiled JavaScript (generated by TypeScript)
â”œâ”€â”€ node_modules/                # npm dependencies
â”œâ”€â”€ .env                         # Environment variables (local)
â”œâ”€â”€ .env.example                 # Environment variables template
â”œâ”€â”€ package.json                 # Dependencies & npm scripts
â”œâ”€â”€ tsconfig.json                # TypeScript configuration
â””â”€â”€ README.md                    # This file
```

## File Descriptions

### Core Application Files

#### `src/index.ts`
**Purpose:** Server initialization, service orchestration, and lifecycle management

**Key Features:**
- Initializes Express server on configurable port (default: 3001)
- Connects to external services:
  - Redis cache (optional, with fallback)
  - PostgreSQL database (optional)
  - Ethereum RPC providers (Alchemy + Infura)
- Non-blocking service initialization with 3-second timeout per service
- Periodic cache cleanup every 10 seconds
- Graceful shutdown handling
- Health check route implementation

**Responsibilities:**
- Server startup and port binding
- Service connection validation
- Periodic maintenance tasks
- Process signal handling

---

#### `src/routes.ts`
**Purpose:** Define all REST API endpoints and request handling

**API Endpoints:**

| Method | Endpoint | Purpose |
|--------|----------|---------|
| `GET` | `/api/ethereum/:address` | Fetch balance, gas price, block number for Ethereum address |
| `GET` | `/api/health` | Health check - confirms server is running |
| `GET` | `/api/test/cache` | Test endpoint - returns cache statistics and status |

**Features:**
- Type-safe request/response handling
- Error handling with meaningful HTTP status codes
- Cache hit/miss tracking in response headers
- Address validation before blockchain queries
- Comprehensive error messages

**Response Example:**
```json
{
  "success": true,
  "data": {
    "address": "0xd8da6bf26964af9d7eed9e03e53415d37aa96045",
    "balance": {
      "ether": "6.762616360912804519",
      "wei": "6762616360912804519"
    },
    "gasPrice": {
      "gwei": "0.088755085",
      "wei": "88755085000"
    },
    "blockNumber": 23896843,
    "timestamp": "2025-11-28T10:30:45.123Z"
  },
  "cached": {
    "balance": false,
    "gasPrice": true,
    "blockNumber": true
  }
}
```

---

#### `src/ethereum.ts`
**Purpose:** Direct integration with Ethereum blockchain via ethers.js v6

**Key Functions:**

| Function | Purpose | Returns |
|----------|---------|---------|
| `getFeeData()` | Get current gas prices (EIP-1559 format) | `{ maxFeePerGas, maxPriorityFeePerGas }` |
| `getBlockNumber()` | Get current blockchain block number | Block number (integer) |
| `getBalance(address)` | Get ETH balance for address | Balance in wei (BigNumber) |

**Features:**
- Automatic RPC provider fallback chain:
  1. Alchemy API (primary)
  2. Infura API (fallback)
  3. Ethers.js public provider (final fallback)
- Unit conversion utilities (wei â†” ETH, wei â†” Gwei)
- Error handling with meaningful messages
- Direct blockchain queries with no caching at this layer

**Environment Requirements:**
- `VITE_ALCHEMY_API_KEY` - Alchemy API key
- `VITE_INFURA_ID` - Infura project ID

---

#### `src/cache.ts`
**Purpose:** Implement dual-layer caching system for performance optimization

**Caching Strategy:**
- **Primary:** Redis (if available) for distributed caching
- **Fallback:** In-memory JavaScript Map for standalone operation
- **TTL:** 30 seconds for global data (gas price, block number)
- **Fresh data:** Account balances always fetch fresh (not cached)

**Key Functions:**

| Function | Purpose |
|----------|---------|
| `getFromCache(key)` | Retrieve cached value if exists and not expired |
| `setCache(key, value, ttl)` | Store value in both Redis and in-memory cache |
| `clearExpiredCache()` | Remove expired entries from in-memory cache |

**Cache Keys:**
- `ethereum:gasPrice` - Current gas prices
- `ethereum:blockNumber` - Current block number

**Features:**
- Automatic expiration based on TTL
- Periodic cleanup to prevent memory leaks
- Graceful degradation if Redis unavailable
- Cache hit/miss tracking for monitoring
- Logs cache operations for debugging

---

#### `src/database.ts`
**Purpose:** Dual persistence layer - simultaneously save to JSON file and PostgreSQL database

**Persistence Strategy:**
- **Always Active:** File-based persistence to `data/balances.json`
- **Optional:** PostgreSQL database (when DATABASE_URL configured)
- **Dual-Save:** Data written to BOTH storage systems simultaneously

**Key Functions:**

| Function | Purpose |
|----------|---------|
| `saveAccountBalance(address, balance)` | Save balance to both JSON and PostgreSQL |
| `getAccountBalance(address)` | Retrieve balance from in-memory or file storage |
| `getAllAccountBalances()` | Get all stored balances |

**Data Structure (balances.json):**
```json
{
  "0xd8da6bf26964af9d7eed9e03e53415d37aa96045": {
    "balance": "6762616360912804519",
    "ether": "6.762616360912804519",
    "timestamp": "2025-11-28T10:30:45.123Z"
  }
}
```

**PostgreSQL Features (Optional):**
- Automatic schema creation if not exists
- Tables: `balances` and `query_history`
- Stores address, balance (wei), balance (ether), and timestamp
- Graceful error handling - fails to PostgreSQL won't break JSON saves

**Environment Requirements:**
- `DATABASE_URL` - PostgreSQL connection string (optional)
- Example: `postgresql://postgres:postgres@localhost:5432/ethereum_db`

---

#### `src/config.ts`
**Purpose:** Centralized environment variable management

**Loaded Variables:**
```typescript
{
  alchemy: string           // Alchemy API key
  infura: string            // Infura project ID
  databaseUrl: string       // PostgreSQL connection string (optional)
  redisUrl: string          // Redis connection URL (optional)
  port: number              // Server port (default: 3001)
  nodeEnv: string           // Environment (development/production)
}
```

**Features:**
- Validates required environment variables on startup
- Provides defaults for optional variables
- Centralizes configuration access across application
- Environment-specific behavior

---

#### `src/middleware.ts`
**Purpose:** Express middleware setup and configuration

**Middleware Included:**
- **CORS:** Cross-Origin Resource Sharing for frontend access
- **Morgan:** HTTP request logging with timestamps
- **JSON Parser:** Automatic JSON request body parsing
- **Error Handler:** Centralized error handling and response formatting

**Features:**
- Logs all incoming requests with method, URL, status code
- Proper error status codes and messages
- CORS headers for frontend communication

---

#### `src/test.ts`
**Purpose:** Interactive testing tool for querying Ethereum addresses and automatically saving data

**Features:**
- Interactive CLI prompts for Ethereum address input
- Automatically saves all queried addresses to `data/balances.json`
- Automatically caches gas price and block number (30s TTL)
- JSON output format for easy integration
- Address format validation (0x + 40 hex characters)
- Shows success/failure status

**Usage:**
```bash
npm run test
```

**How It Works:**
1. Server must be running (`npm run dev` in another terminal)
2. Enter an Ethereum address (0x...)
3. Address automatically saves to balances.json
4. Data cached for 30 seconds
5. JSON response displayed

**Example Interaction:**
```
ğŸ“Š Ethereum Address Tracker
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Enter an Ethereum address (0x...)
   Automatically saves to balances.json
   Caches gas price & block number
   Type "exit" to quit

ğŸ” Enter Ethereum address (or "exit" to quit): 0xd8da6bf26964af9d7eed9e03e53415d37aa96045
âœ… Saved to balances.json
âœ… Cached gas price and block number (30s TTL)

{
  "success": true,
  "data": {
    "address": "0xd8da6bf26964af9d7eed9e03e53415d37aa96045",
    "balance": { "ether": "6.762616360912804519", "wei": "6762616360912804519" },
    "gasPrice": { "gwei": "0.088755085", "wei": "88755085000" },
    "blockNumber": 23896843,
    "timestamp": "2025-11-28T15:23:09.266Z"
  },
  "cached": { "balance": false, "gasPrice": true, "blockNumber": true }
}
```

**Data Persistence:**
- âœ… Automatically saves to `data/balances.json`
- âœ… Creates new entries for new addresses
- âœ… Updates `last_updated` timestamp for existing addresses
- âœ… Caches gas price and block number for 30 seconds to reduce API calls

---

### Testing & Utility Files

#### `src/simple-test.ts`
**Purpose:** Automated (non-interactive) test script for batch address queries

**Usage:**
```bash
npm run test:simple
```

**Features:**
- No user interaction required
- Tests multiple addresses automatically
- Displays success/failure for each address
- Automatically saves to balances.json
- Useful for CI/CD pipelines

---

### Data & Configuration Files

#### `data/balances.json`
**Purpose:** File-based persistence of Ethereum account balances

**Format (Array of Address Objects):**
```json
[
  {
    "address": "0xd8da6bf26964af9d7eed9e03e53415d37aa96045",
    "balance": "6.762616360912804519",
    "balance_wei": "6762616360912804519",
    "last_updated": "2025-11-28T15:23:09.266Z",
    "created_at": "2025-11-28T11:11:31.150Z"
  },
  {
    "address": "0xab5801a7d398351b8be11c439e05c5b3259aec9b",
    "balance": "1.027475750016846791",
    "balance_wei": "1027475750016846791",
    "last_updated": "2025-11-28T15:23:09.266Z",
    "created_at": "2025-11-28T12:00:22.182Z"
  }
]
```

**Features:**
- Auto-updated whenever an address is queried
- Tracks `created_at` timestamp for first query
- Updates `last_updated` for subsequent queries
- Stores both human-readable (ether) and raw (wei) balance values
- Automatically created if doesn't exist

---

#### `.env`
**Purpose:** Local environment variables (do NOT commit to git)

**Required Variables:**
```bash
VITE_ALCHEMY_API_KEY=your_alchemy_key_here
VITE_INFURA_ID=your_infura_id_here
```

**Optional Variables:**
```bash
DATABASE_URL=postgresql://postgres:postgres@localhost:5432/ethereum_db
REDIS_URL=redis://localhost:6379
NODE_ENV=development
PORT=3001
```

---

#### `.env.example`
**Purpose:** Template for environment variables

Shows which variables are needed and their format. Copy to `.env` and fill in values.

---

#### `package.json`
**Purpose:** npm package configuration and dependencies

**Available Scripts:**
```bash
npm run dev           # Start server in development mode (ts-node)
npm run test          # Run interactive test tool (queries manually)
npm run test:simple   # Run automated test (batch process multiple addresses)
npm run build         # Compile TypeScript to JavaScript
npm start             # Run compiled JavaScript
npm run typecheck     # Check TypeScript types without building
```

**Core Dependencies:**
- `express` - Web framework
- `ethers` - Ethereum library
- `pg` - PostgreSQL client
- `redis` - Redis client
- `cors` - CORS middleware
- `morgan` - HTTP logging
- `dotenv` - Environment variable loading

---

#### `tsconfig.json`
**Purpose:** TypeScript compilation configuration

**Key Settings:**
- Target: ES2020 JavaScript
- Module: CommonJS
- Strict mode enabled
- Output directory: `dist/`

---

## ğŸš€ Getting Started

### Prerequisites
- Node.js 18+ and npm
- (Optional) Redis server for distributed caching
- (Optional) PostgreSQL database for additional persistence

### Installation
```bash
cd backend
npm install
```

### Configuration
```bash
cp .env.example .env
```

Edit `.env` and add required variables:
```bash
VITE_ALCHEMY_API_KEY=your_alchemy_api_key
VITE_INFURA_ID=your_infura_project_id
PORT=3001
NODE_ENV=development
```

### Running the Server

**Development Mode:**
```bash
npm run dev
```
Server starts on `http://localhost:3001`

**With Interactive Testing (2 Terminals):**

Terminal 1:
```bash
npm run dev
```

Terminal 2:
```bash
npm run test
```
Then enter Ethereum addresses. Each address automatically saves to `data/balances.json`.

**Automated Testing:**
```bash
npm run test:simple
```
Queries multiple predefined addresses and saves results.

**Production Build:**
```bash
npm run build
npm start
```

---

## ğŸ”„ Data Flow

```
User Request
    â†“
[routes.ts] - Route handler
    â†“
[ethereum.ts] - Check cache first
    â”œâ†’ [cache.ts] - Try Redis or in-memory
    â””â†’ If not cached: Query Ethereum RPC
    â†“
[database.ts] - Save result
    â”œâ†’ Save to balances.json
    â””â†’ Save to PostgreSQL (if configured)
    â†“
Return JSON Response
```

---

## ğŸ“Š Service Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       Express Server (3001)         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Routes  â”‚  Middleware  â”‚  Config   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚         Cache Layer (30s TTL)       â”‚
â”‚    Redis (opt) | In-Memory (req)    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚     Ethereum RPC (Alchemy + Infura) â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚      Persistence Layer              â”‚
â”‚  JSON File | PostgreSQL (optional)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” API Examples

### Get Ethereum Account Data
```bash
curl http://localhost:3001/api/ethereum/0xd8da6bf26964af9d7eed9e03e53415d37aa96045
```

### Health Check
```bash
curl http://localhost:3001/api/health
```

### Cache Status
```bash
curl http://localhost:3001/api/test/cache
```

---

## ğŸ“ Key Features & Notes

### Data Persistence
- âœ… **Always saves to balances.json** - File-based persistence activated automatically
- âœ… **Caches gas price & block number** for 30 seconds to reduce API calls
- âœ… **Account balances always fresh** - Never cached, always queried live
- âœ… **Optional PostgreSQL** - If DATABASE_URL set, data also persists to database
- âœ… **Optional Redis** - Falls back to in-memory caching if Redis unavailable

### How test.ts Works
1. Run `npm run test` in separate terminal while server is running
2. Enter Ethereum address (0x followed by 40 hex characters)
3. System automatically:
   - Queries Ethereum blockchain via Alchemy/Infura
   - Saves address and balance to `data/balances.json`
   - Caches gas price and block number (30s)
   - Returns JSON response with data
4. Type "exit" to quit

### System Behavior
- **Server Required:** test.ts needs backend API running (`npm run dev`)
- **Network Calls:** 1 call per new address, caches prevent duplicate gas/block calls
- **File Updates:** `data/balances.json` updated on every query
- **Error Handling:** Graceful degradation - works without Redis or PostgreSQL
- **Logging:** Server logs show all database saves and cache operations

## ğŸ› ï¸ Development Tips

1. **Check Server Logs:** Look for `[DB] Saved to balances.json` messages
2. **View Saved Data:** Check `data/balances.json` for persisted addresses
3. **Monitor Cache:** Server logs show cache hits/misses
4. **TypeScript:** Run `npm run typecheck` to validate types
5. **Test Different Addresses:** Use valid Ethereum addresses to see file updates

## â“ Troubleshooting

| Issue | Solution |
|-------|----------|
| "Server not running" in test.ts | Start server first: `npm run dev` in another terminal |
| Address not saving to balances.json | Check server logs for `[DB] Saved` messages |
| Invalid address error | Ensure address is `0x` + 40 hex characters (42 total) |
| API returns error | Verify Alchemy API key and Infura ID in .env |
| TypeScript compilation errors | Run `npm install` to ensure all types are installed |

---

## ğŸ“š Related Documentation

- **PostgreSQL Setup:** See `POSTGRESQL_SETUP.md`
- **Database Schema:** See `DATABASE_SCHEMA.md`
- **Frontend:** See `../frontend/README.md`

